<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elderly Hillberry Weather Station</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 800px;
        width: 100%;
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .current-time {
        text-align: center;
        color: #666;
        font-size: 1.2em;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .loading {
        text-align: center;
        color: #666;
        font-size: 1.1em;
        padding: 40px;
      }

      .error {
        text-align: center;
        color: #d32f2f;
        font-size: 1.1em;
        padding: 40px;
        background: #ffebee;
        border-radius: 10px;
        margin: 20px 0;
      }

      .rainfall-list {
        list-style: none;
      }

      .rainfall-item {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 10px;
        border-left: 5px solid #667eea;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .rainfall-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .rainfall-item.today {
        border-left-color: #4caf50;
        background: linear-gradient(135deg, #4caf5015 0%, #8bc34a15 100%);
      }

      .day-label {
        font-weight: bold;
        color: #333;
        font-size: 1.2em;
        margin-bottom: 5px;
      }

      .rainfall-amount {
        font-size: 2em;
        color: #667eea;
        font-weight: bold;
        margin: 10px 0;
      }

      .rainfall-item.today .rainfall-amount {
        color: #4caf50;
      }

      .time-range {
        color: #999;
        font-size: 0.9em;
      }

      .subtitle {
        text-align: center;
        color: #999;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      @media (max-width: 600px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 1.8em;
        }

        .rainfall-amount {
          font-size: 1.5em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåßÔ∏è Elderly Hillberry Weather Station</h1>
      <div class="subtitle">7-Day Precipitation Report</div>
      <div class="current-time" id="current-time">Loading...</div>
      <div class="current-conditions" id="current-conditions" style="text-align: center; color: #666; font-size: 1.1em; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #eee;">
        <span id="conditions-text">Loading current conditions...</span>
      </div>
      <div id="content">
        <div class="loading">Fetching rainfall data...</div>
      </div>
    </div>

    <script>
      // Update current time
      function updateCurrentTime() {
        const now = new Date();
        document.getElementById("current-time").textContent =
          "Current Time: " + now.toLocaleString();
      }

      // Get wind direction arrow
      function getWindArrow(degrees) {
        const arrows = ['‚Üì', '‚Üô', '‚Üê', '‚Üñ', '‚Üë', '‚Üó', '‚Üí', '‚Üò'];
        const index = Math.round(degrees / 45) % 8;
        return arrows[index];
      }

      // Fetch current conditions
      async function fetchCurrentConditions() {
        try {
          const response = await fetch("/.netlify/functions/get-current");
          const data = await response.json();

          if (!response.ok || data.error) {
            throw new Error(data.error || "Failed to fetch current conditions");
          }

          // Convert temperature to Fahrenheit
          const tempF = Math.round((data.temperature * 9/5) + 32);
          
          // Convert wind speed from m/s to mph
          const windMph = Math.round(data.windSpeed * 2.237);
          
          const windArrow = getWindArrow(data.windDirection);

          // Get temperature color (blue at 32¬∞F, red at 90¬∞F, gradient in between)
          let tempColor;
          if (tempF <= 32) {
            tempColor = '#2196F3'; // blue
          } else if (tempF >= 90) {
            tempColor = '#f44336'; // red
          } else {
            // Gradient from blue to red
            const ratio = (tempF - 32) / (90 - 32);
            const r = Math.round(33 + (244 - 33) * ratio);
            const g = Math.round(150 + (67 - 150) * ratio);
            const b = Math.round(243 + (54 - 243) * ratio);
            tempColor = `rgb(${r}, ${g}, ${b})`;
          }

          document.getElementById("conditions-text").innerHTML = 
            `<strong>Now:</strong> <span style="color: ${tempColor}; font-weight: bold; font-size: 1.2em;">${tempF}¬∞F</span> | ${windMph} mph <span style="font-size: 1.5em;">${windArrow}</span> | <span style="font-weight: bold; color: #667eea; font-size: 1.15em;">${data.rainfallToday}" rain</span> since 7am`;
        } catch (error) {
          document.getElementById("conditions-text").textContent = 
            "Current conditions unavailable";
        }
      }

      // Fetch rainfall data
      async function fetchRainfallData() {
        try {
          const response = await fetch(
            "/.netlify/functions/get-rainfall?days=7"
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to fetch data");
          }

          if (data.error) {
            throw new Error(data.error);
          }

          displayRainfallData(data);
        } catch (error) {
          document.getElementById("content").innerHTML = `<div class="error">
                        <strong>Error loading rainfall data:</strong><br>
                        ${error.message}<br><br>
                        <small>Please check that environment variables (API_KEY and DEVICE_ID) are set in Netlify.</small>
                    </div>`;
        }
      }

      // Display rainfall data
      function displayRainfallData(data) {
        const today = new Date().toLocaleDateString();

        let html = '<ul class="rainfall-list">';

        data.days.forEach((day, index) => {
          const isToday = index === 0;
          const dayLabel = isToday
            ? "Today"
            : index === 1
            ? "Yesterday"
            : `${index} days ago`;

          html += `
                    <li class="rainfall-item ${isToday ? "today" : ""}">
                        <div class="day-label">${dayLabel}</div>
                        <div class="rainfall-amount">${
                          day.rainfallInches
                        }" rain</div>
                        <div class="time-range">${day.startTime} ‚Üí ${
            day.endTime
          }</div>
                        <div class="time-range">(${day.rainfallMM} mm)</div>
                    </li>
                `;
        });

        html += "</ul>";

        document.getElementById("content").innerHTML = html;
      }

      // Initialize
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000); // Update time every second
      fetchRainfallData();
      fetchCurrentConditions();
      setInterval(fetchCurrentConditions, 60000); // Update current conditions every minute
    </script>
  </body>
</html>
